<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TOto</title>
    <!-- bootstrap dependencies -->
    <link rel="stylesheet" type="text/css" href="bower_components/bootstrap/dist/css/bootstrap.css">
    <!-- dc.js dependencies -->
    <link rel="stylesheet" type="text/css" href="bower_components/dc.js/dc.css">

    <!-- Custom styles for this template -->
    <!--<link href="css/dashboard_template.css" rel="stylesheet">-->

</head>


<body>


<!-- bootstrap dependencies -->
<script src="bower_components/jquery/dist/jquery.js"></script>
<script src="bower_components/bootstrap/dist/js/bootstrap.js"></script>

<!-- dc.js dependencies -->
<script type="text/javascript" src="bower_components/d3/d3.js"></script>
<script type="text/javascript" src="bower_components/crossfilter2/crossfilter.js"></script>
<script type="text/javascript" src="bower_components/dc.js/dc.js"></script>



<div class="container">

    <div class="starter-template">
        <h1>KPI 1.1 alpha : Taux de digitalisation du suivi de commande.</h1>
        <p class="lead">Taux de digitalisation des suivis de commande.<br> Resultats obtenus à partir de MongoDb.</p>
    </div>

    <div id="test"></div>

    <div id="test2"></div>

    <script type="text/javascript">

        var chart = dc.barChart("#test");
        var lineChart = dc.lineChart('#test2');


        var dateFormat = d3.time.format("%d/%m/%y");

        function toObj(d) {
            console.log(d);
            console.log("converted");
            return {
                date: dateFormat.parse(d.date), // parse dates as js Date objects
                txDigitalization: d3.round(+d.TxDigitalization * 100) // coerce to number in %
            };
        }

        function reduceAddAvg(field){
          return function reduceAddAvg(p,v) {
              ++p.count;
              p.sum += v[field];
              p.avg = p.sum/p.count;
              return p;
          };
        };

        function reduceRemoveAvg(field){
          return function reduceRemoveAvg(p,v) {
              --p.count
              p.sum -= v[field];
              p.avg = p.sum/p.count;
              return p;
          };
        };

        function reduceInitAvg() {
            return {count:0, sum:0, avg:0};
        }


        d3.tsv("data/fake_digitalization_rate.tsv",toObj ,  function(error, experiments) {

            experiments.forEach(function(x) { // display data
                console.log(x);
            });

            var ndx                 = crossfilter(experiments);
            var yearlyDimension     = ndx.dimension(function(d) {return d3.time.year(d.date);}); // create a date index
            var monthDimension      = ndx.dimension(function(d) {return d3.time.month.floor(d.date);});

            var yearlyMeanGroup     = yearlyDimension.group()
                    .reduce(reduceAddAvg("txDigitalization"),
                            reduceRemoveAvg("txDigitalization"),
                            reduceInitAvg);
            var monthlyMeanGroup    = monthDimension.group()
                    .reduce(reduceAddAvg("txDigitalization"),
                            reduceRemoveAvg("txDigitalization"),
                            reduceInitAvg);



            chart
                .width(768)
                .height(480)
                .margins({top: 50, right: 50, bottom: 50, left: 50})
                .dimension(monthDimension)
                .group(yearlyMeanGroup)
                .x(d3.scale.ordinal())
                .xUnits(dc.units.ordinal)
                //.x(d3.time.scale().domain([new Date(2014, 0, 1), new Date(2018, 0, 2)]))
                //.round(d3.time.year.floor)
                //.alwaysUseRounding(true)
                //.xUnits(d3.time.years)
                //.elasticX(true)
                .xAxisLabel("Année")
                .y(d3.scale.linear().domain([0, 100]))
                .yAxisLabel("Suivis de commande digitaux (%)")
                .brushOn(false)
                .valueAccessor(function (p) {
                    return p.value.avg;
                })
                .label(function (p) {
                    return p.key;
                })
                //.on('renderlet', function(chart) { // todo filter the selected year on click
                //    chart.selectAll('rect').on("click", function(d) {
                //        console.log("click!", d);
                //        console.log("click!", d.data);
                //        console.log("click!", d.data.value);
                //    });
                //})
                ;

             //chart.xAxis().ticks(d3.time.year,1);









            lineChart
              //.renderArea(true)
              .width(990)
              .height(200)
              .transitionDuration(1000)
              .margins({top: 30, right: 50, bottom: 25, left: 40})
              .dimension(monthDimension)
              .mouseZoomable(true)
              //.rangeChart(volumeChart)
              .x(d3.time.scale().domain([new Date(2014, 0, 1), new Date(2018, 0, 1)]))
              .round(d3.time.month.round)
              .xUnits(d3.time.months)
              //.elasticX(true)
              .y(d3.scale.linear().domain([0, 100]))
              //.elasticY(true)
              .renderHorizontalGridLines(true)
              //.legend(dc.legend().x(800).y(10).itemHeight(13).gap(5))
              .brushOn(false)
              .group(monthlyMeanGroup)
              .valueAccessor(function (d) {
                return d.value.avg;
              })

            chart.render();
            lineChart.render();








//d3.select(".line").attr("fill-opacity", 0);






        });
    </script>


</div>


</body>


</html>
